<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Reflex Shot - Le Duel de R√©flexes</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        #game-container {
            width: 100%;
            max-width: 1200px;
        }

        #header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #welcome-message {
            margin: 0;
            font-size: 24px;
            color: #333;
        }

        #connection-status {
            font-weight: bold;
        }

        #btn-logout {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        #btn-logout:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }

        #game-area {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            cursor: default;
        }

        #game-area.clickable {
            cursor: pointer;
        }

        #game-area.color-red {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        #game-area.color-green {
            background: linear-gradient(135deg, #51cf66 0%, #38d9a9 100%);
            cursor: pointer;
        }

        #instruction-text {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        #game-area.color-red #instruction-text,
        #game-area.color-green #instruction-text {
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        #round-info {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #666;
        }

        #game-area.color-red #round-info,
        #game-area.color-green #round-info {
            color: rgba(255, 255, 255, 0.9);
        }

        #players-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .player-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .player-score {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .player-status {
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .player-status.ready {
            background: #51cf66;
            color: white;
        }

        .player-status.waiting {
            background: #ffd43b;
            color: #333;
        }

        #btn-ready {
            background: #51cf66;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 20px;
        }

        #btn-ready:hover:not(:disabled) {
            background: #40c057;
            transform: scale(1.05);
        }

        #btn-ready:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #result-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .result-good {
            background: #51cf66;
            color: white;
        }

        .result-bad {
            background: #ff6b6b;
            color: white;
        }

        #ranking {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        #ranking h2 {
            margin-top: 0;
            color: #333;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .rank-item.first {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        }

        .rank-item.second {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
        }

        .rank-item.third {
            background: linear-gradient(135deg, #cd7f32 0%, #daa520 100%);
        }

        .hidden {
            display: none !important;
        }

        #btn-play-again {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s;
        }

        #btn-play-again:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <div>
                <h3 id="welcome-message">Bienvenue, Joueur !</h3>
                <p>Connexion : <span id="connection-status" style="color:orange;">En attente...</span></p>
            </div>
            <button id="btn-logout">D√©connexion</button>
        </div>

        <div id="players-area"></div>

        <div id="game-area">
            <div id="round-info">En attente des joueurs...</div>
            <div id="instruction-text">Cliquez sur "Pr√™t" pour commencer</div>
            <button id="btn-ready" disabled>PR√äT !</button>
            <div id="result-message" class="hidden"></div>
        </div>

        <div id="ranking" class="hidden">
            <h2>üèÜ Classement Final</h2>
            <div id="ranking-list"></div>
            <button id="btn-play-again" onclick="location.reload()">Rejouer</button>
        </div>
    </div>
    <script>
        // Configuration variables (deduplicated)


        let SERVER_CONFIG = null;
        let WS_URL = null; // will be set by fetchServerConfig() or fallback
        let ws = null;     // single websocket variable (deduplicated)
        let playerName = '';
        let gameActive = false;
        let canClick = false;
        let wsConnected = false;
        let pendingReady = false;

        // DOM
        const gameArea = document.getElementById('game-area');
        const instructionText = document.getElementById('instruction-text');
        const roundInfo = document.getElementById('round-info');
        const welcomeMessage = document.getElementById('welcome-message');
        const connectionStatus = document.getElementById('connection-status');
        const playersArea = document.getElementById('players-area');
        const btnReady = document.getElementById('btn-ready');
        const resultMessage = document.getElementById('result-message');
        const ranking = document.getElementById('ranking');
        const rankingList = document.getElementById('ranking-list');

        // --- Server config fetch ---
        async function fetchServerConfig() {
            try {
                const response = await fetch('/api/config');
                SERVER_CONFIG = await response.json();
                // set WS_URL from server config if provided
                if (SERVER_CONFIG && SERVER_CONFIG.wsReflexUrl) {
                    WS_URL = SERVER_CONFIG.wsReflexUrl;
                }
                return true;
            } catch (error) {
                console.error('Failed to fetch server config:', error);
                // fallback to a sensible default using page protocol and hostname
                const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
                // Use hostname to allow flexible deployments; keep explicit host as last-resort
                WS_URL = `${proto}://${window.location.hostname}:8081`;
                console.warn('Falling back to default WS URL:', WS_URL);
                return false;
            }
        }

        // --- Constants for fallback / debugging ---
        const DEFAULT_EXPLICIT_HOST = '10.15.2.246';
        const DEFAULT_EXPLICIT_PORT = 8081;

        // --- Connect WebSocket (uses WS_URL set by init) ---
        function connectWebSocket() {
            // Ensure WS_URL exists; if not, build a fallback using explicit host
            if (!WS_URL) {
                const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
                WS_URL = `${proto}://${DEFAULT_EXPLICIT_HOST}:${DEFAULT_EXPLICIT_PORT}/`;
                console.warn('WS_URL was not set by config, using explicit fallback:', WS_URL);
            }

            // Avoid creating a new socket while one is connecting/open
            if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
                console.log('WS already connecting/open, state=', ws.readyState);
                return;
            }

            console.log('Attempting WebSocket connection to', WS_URL);
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('WS opened (readyState=', ws.readyState, ')');
                wsConnected = true;
                // reset UI state
                connectionStatus.innerText = 'Connect√©';
                connectionStatus.style.color = 'green';
                btnReady.disabled = false;
                btnReady.textContent = 'PR√äT !';

                // announce join to server
                ws.send(JSON.stringify({
                    type: 'JOIN',
                    playerName: playerName,
                    playerId: playerNameId
                }));

                if (pendingReady) {
                    pendingReady = false;
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'READY' }));
                        btnReady.disabled = true;
                        btnReady.textContent = 'En attente...';
                        instructionText.textContent = 'En attente des autres joueurs...';
                    }
                }
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    console.error('Invalid WS message', e);
                }
            };

            ws.onclose = (ev) => {
                console.warn('WS closed', ev);
                wsConnected = false;
                connectionStatus.innerText = 'D√©connect√©';
                connectionStatus.style.color = 'red';
                btnReady.disabled = true;

                // reconnect with backoff
                let retryDelay = 1000;
                setTimeout(() => {
                    console.log('Retry WS connexion...');
                    connectWebSocket();
                }, retryDelay);
            };

            ws.onerror = (err) => {
                console.error('WS error:', err);
                // close socket to trigger onclose and retry logic
                try { ws.close(); } catch (e) { /* ignore */ }
            };
        }

        // --- Message Handling ---
        function handleMessage(data) {
            console.log('Send message:', data);

            switch (data.type) {
                case 'CONNECTED':
                    console.log(data.content);
                    break;

                case 'GAME_STATE':
                    updatePlayersDisplay(data.payload.players);
                    if (data.payload.gameActive) {
                        roundInfo.textContent = `Round ${data.payload.currentRound} / ${data.payload.totalRounds}`;
                    }
                    break;

                case 'PLAYER_JOINED':
                    instructionText.textContent =
                        `${data.payload.playerName} a rejoint ! (${data.payload.playerCount} joueur(s))`;
                    break;

                case 'PLAYER_LEFT':
                    instructionText.textContent = `${data.payload.playerName} a quitt√© (${data.payload.playerCount} joueur(s))`;
                    break;

                case 'ROUND_START':
                    gameActive = true;
                    canClick = false;
                    btnReady.classList.add('hidden');
                    resultMessage.classList.add('hidden');
                    gameArea.classList.remove('color-green', 'clickable');
                    gameArea.classList.add('color-red');
                    roundInfo.textContent = `Round ${data.payload.round}`;
                    instructionText.textContent = 'Attendez le VERT...';
                    break;

                case 'COLOR_CHANGE':
                    if (data.payload.color === 'green') {
                        canClick = true;
                        gameArea.classList.remove('color-red');
                        gameArea.classList.add('color-green', 'clickable');
                        instructionText.textContent = 'üéØ CLIQUEZ MAINTENANT !';
                    }
                    break;

                case 'EARLY_CLICK':
                    canClick = false;
                    showResult(data.payload.message, false);
                    break;

                case 'VALID_CLICK':
                    canClick = false;
                    gameArea.classList.remove('clickable');
                    showResult(
                        `‚ö° ${data.payload.reactionTime}ms ! +${data.payload.points} points`,
                        true
                    );
                    break;

                case 'ROUND_END':
                    gameArea.classList.remove('color-red', 'color-green', 'clickable');
                    instructionText.textContent = 'Round termin√© !';
                    updatePlayersDisplay(data.payload.results.map(r => ({
                        name: r.name,
                        score: r.score,
                        ready: true
                    })));
                    break;

                case 'GAME_END':
                    showFinalRanking(data.payload.ranking);
                    const player = data.payload.ranking.find(p => p.name === playerName);
                    const playerScore = player ? player.score : 0;
                    sendScoresToAPI(playerScore, playerNameId)
                        .then(response => {
                            console.log('Score sent successfully to API:', response);

                        })
                        .catch(error => {
                            console.error('Error sending score to API:', error);
                        });
                    break;

                case 'GAME_CANCELLED':
                    gameActive = false;
                    instructionText.textContent = data.payload.message;
                    btnReady.classList.remove('hidden');
                    btnReady.disabled = false;
                    gameArea.classList.remove('color-red', 'color-green', 'clickable');
                    break;
            }
        }

        // --- UI Functions ---
        function updatePlayersDisplay(players) {
            playersArea.innerHTML = '';
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.innerHTML = `
                    <h3>${player.name}</h3>
                    <div class="player-score">${player.score || 0} pts</div>
                    <div class="player-status ${player.ready ? 'ready' : 'waiting'}">
                        ${player.ready ? '‚úì Pr√™t' : 'En attente...'}
                    </div>
                `;
                playersArea.appendChild(card);
            });
        }

        function showResult(message, isGood) {
            resultMessage.textContent = message;
            resultMessage.className = isGood ? 'result-good' : 'result-bad';
            resultMessage.classList.remove('hidden');
        }

        function showFinalRanking(rankingData) {
            gameArea.classList.add('hidden');
            ranking.classList.remove('hidden');

            rankingList.innerHTML = '';
            rankingData.forEach((player, index) => {
                const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';

                const item = document.createElement('div');
                item.className = `rank-item ${rankClass}`;
                item.innerHTML = `
                    <span style="font-size: 1.5em;">${medal} ${player.rank}. ${player.name}</span>
                    <span style="font-size: 1.5em; font-weight: bold;">${player.score} pts</span>
                `;
                rankingList.appendChild(item);
            });
        }

        // --- Event Listeners ---
        btnReady.addEventListener('click', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'READY' }));
                btnReady.disabled = true;
                btnReady.textContent = 'En attente...';
                instructionText.textContent = 'En attente des autres joueurs...';
            } else {
                pendingReady = true;
                btnReady.disabled = true;
                btnReady.textContent = 'Connexion...';
                instructionText.textContent = 'Connexion en cours, envoi du statut PR√äT apr√®s connexion.';
            }
        });

        gameArea.addEventListener('click', () => {
            if (canClick && gameActive) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'CLICK' }));
                } else {
                    showResult("Connection lost, unable to send click", false);
                }
            }
        });

        document.getElementById('btn-logout').onclick = logout;

        function logout() {
            document.cookie = "sb-access-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            document.cookie = "user-name=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            if (ws) {
                ws.close();
            }
            window.location.href = '/login';
        }

        // --- User Info ---
        function getUserInfo() {
            const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('sb-access-token='));


            if (!tokenCookie) {
                window.location.href = '/login';
                return;
            }

            const nameCookie = document.cookie.split('; ').find(row => row.startsWith('user-name='));
            const userIdCookie = document.cookie.split('; ').find(row => row.startsWith('user-id='));
            if (nameCookie) {
                playerName = decodeURIComponent(nameCookie.split('=')[1]);
                playerNameId = decodeURIComponent(userIdCookie.split('=')[1]);
            } else {
                playerName = 'Joueur';
            }

            welcomeMessage.innerText = `Bienvenue, ${playerName} !`;
        }

        // --- Init ---
        async function init() {
            getUserInfo();
            await fetchServerConfig(); // sets WS_URL or fallback
            connectWebSocket();
        }

        init();
        async function sendScoresToAPI(ranking, playerNameId) {
            const API_URL = `http://${DEFAULT_EXPLICIT_HOST}:3000/api/v1/scores`;
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "userID": playerNameId,
                        "value": ranking
                    })
                });
                if (!res.ok) {
                    throw new Error(`API responded with status ${res.status}`);
                }
                return await res.json();
            } catch (err) {
                throw err;
            }
        }
    </script>

</body>
</html>